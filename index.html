<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Abfahrten</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    html {
        font-size: 20px;
    }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        padding-bottom: 2rem;
    }
    /*section.collapsed::after {
        content: "▼";
        position: absolute;
        right: 1rem;
        margin-top: -2.5rem;
        color: gray;
    }*/
    header {
        background-color: #ddd;
        padding: 0.5rem;
        border-bottom: 1px solid #ccc;
    }
    h1 {
        font-weight: bold;
        font-size: 1.3em;
    }
    h2 {
        color: #888;
        font-size: 1em;
    }
    table {
        width: 100%;
    }
    table:not(:empty) {
        padding: 0.5rem;
    }
    table tr:not(:last-child) td {
        padding-bottom: 0.2rem;
    }
    table td:nth-child(1) {
        width: 10%;
        font-style: italic;
    }
    table td:nth-child(2) {
        width: 65%;
    }
    table td:nth-child(3) {
        width: 25%;
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-weight: bold;
    }
    input {
        width: 100%;
        position: fixed;
        bottom: 0;
        border: 0;
        border-radius: 0;
        background-color: #e8e8e8;
        font: inherit;
        height: 2rem;
        padding: 0.5rem;
        outline: none;
    }
    ul, #searched {
        box-shadow: 0 -0.5rem 2rem rgba(0,0,0,0.2);
        position: fixed;
        bottom: 2rem;
        max-height: 70vh;
        overflow: scroll;
        background-color: white;
        width: 100%;
    }
    li {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    li:not(:last-child) {
        border-bottom: 1px solid #ddd;
    }
    </style>
    <script>
        function apifahrten(request, onCompletion) {  // request parameters and a function dealing with response text
            var api = new XMLHttpRequest();

            api.onreadystatechange = function() {
                if (api.readyState == 4 && api.status == 200) {
                    onCompletion(api.responseText);
                }
            }

            api.open("POST", "apifahrten.php", true);
            api.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            api.send(request);
        }

        function get(id, targetSectionId) {
            apifahrten("format=html&id=" + id, function(response) {
                var departures = response;
                var target = document.getElementById(targetSectionId);

                // replace the old table with the new one, which is just a
                // string, necessitating the creation of a temporary helper div
                var table = target.getElementsByTagName("table")[0];
                var div = document.createElement("div");
                div.innerHTML = departures;
                table.parentNode.replaceChild(div.firstChild, table);
            });
        }
        function search() {
            var searchString = document.getElementById("search").value;

            apifahrten("format=html&search=" + encodeURIComponent(searchString), function(response) {
                var matches = response;

                // display search results
                var results = document.getElementById("results");
                results.innerHTML = matches;

                // if one of them is clicked, load its upcoming departures
                lis = document.getElementsByTagName("li");
                for (li of lis) li.onclick = function() {

                        // hide search results
                        results.innerHTML = "";

                        // grab target section
                        var searched = document.getElementById("searched");

                        // clean up from potential earlier searches
                        searched.innerHTML = "";

                        // construct header and an empty table, later to be
                        // replaced by get()
                        var header = document.createElement("header");
                        header.innerHTML = (this.innerHTML);
                        searched.appendChild(header);
                        var table = document.createElement("table");
                        searched.appendChild(table);
                        get(this.id, "searched");
                };
            });
        }
        function toggle(header) {
            var section = header.parentNode;
            var tables = section.getElementsByTagName("table");
            if (tables.length == 0) {
                var table = document.createElement("table");
                section.appendChild(table);
                get(section.id, section.id);
                section.scrollIntoView();
            } else {
                tables[0].parentNode.removeChild(tables[0]);
            }
        }
    </script>
</head>
<body>
    <section id="100005">
        <header onclick="toggle(this)">
            <h1>Hauptbahnhof</h1>
            <h2>→ Steig E</h2>
        </header>
    </section>
    <section id="25207">
        <header onclick="toggle(this)">
            <h1>Sand Drosselweg</h1>
        </header>
        <table></table>
    </section>
    <script>
        get(25207, "25207");
    </script>
    <section id="50504">
        <header onclick="toggle(this)">
            <h1>Pauline-Krone-Heim</h1>
            <h2>→ Hauptbahnhof</h2>
        </header>
    </section>
    <section id="50804">
        <header onclick="toggle(this)">
            <h1>Stadtgraben</h1>
        </header>
    </section>
    <section id="81004">
        <header onclick="toggle(this)">
            <h1>Sternplatz</h1>
            <h2>→ Hauptbahnhof</h2>
        </header>
    </section>

    <section id="searched">
    </section>
    <footer>
        <input name="search" id="search" onkeyup="search()" placeholder="Haltestelle..."></input>
        <section id="results">

        </section>
    </footer>
</body>
</html>
